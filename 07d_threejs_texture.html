<html>
  <body>
    <script src="three.min.js"></script>
    <script src="gg_util_cellular.js"></script>

      <script id="vertexShader" type="x-shader/x-vertex">

        // comes with framework
        uniform mat4 modelViewMatrix;
        uniform mat4 projectionMatrix;

        // user defined uniforms, values are passed in runtime
        uniform float time;

        // user defined attributes
        attribute vec3 position;
        attribute vec4 color;
        attribute vec3 normal;

        // data to be passed to fragment shader
        varying vec3 v_position;
        varying vec4 v_color;

        void main() {

          vec4 positionNew = vec4 (position, 1.0);

          // calcuate pixel position on screen and pass to fragment shader
          gl_Position = projectionMatrix * modelViewMatrix * positionNew;

          // pass world coords position to fragment shader
          v_position = positionNew.xyz;

          // pass color to fragment shader
          v_color = vec4(position.x*0.001, position.y*0.01, position.z*0.001, 1.0);
        }

        </script>

        <script id="fragmentShader" type="x-shader/x-fragment">

          precision mediump float;
          precision mediump int;

          // input from vertex shader
          varying vec3 v_position;
          varying vec4 v_color;

          void main() {
            gl_FragColor = v_color;
          }
        </script>

    <script>

    var scene;
    var camera;
    var mesh;
    var material;
    var renderer;

    var bufferScene = new THREE.Scene();
    var bufferTexture = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight, { minFilter: THREE.LinearFilter, magFilter: THREE.NearestFilter});



    function init_gl() {

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera (70, window.innerWidth/window.innerHeight, 0.1, 50000);

      // default params
      renderer = new THREE.WebGLRenderer();
      renderer.setSize (window.innerWidth, window.innerHeight);
      document.body.appendChild (renderer.domElement);

      material = new THREE.RawShaderMaterial ({
                            uniforms: {
                              time: { type: "f", value: 1.0 }
                            },
                            vertexShader: document.getElementById ('vertexShader').textContent,
                            fragmentShader: document.getElementById ('fragmentShader').textContent,
                            side: THREE.DoubleSide,
                            transparent: true
                        });

      var W = 10;
      var geometry = new THREE.Geometry();
      var N = 200;

      for (var i=0; i<N; i++) {
        for (var j=0; j<N; j++) {

          var H = 1000;
          geometry.vertices.push(
    	       new THREE.Vector3 ((i-1)*W,  cell_noise.value((i-1)/N, j/N)[0]*H, j*W ),

    	       new THREE.Vector3 ((i-1)*W, cell_noise.value((i-1)/N, (j-1)/N)[0]*H, (j-1)*W),

    	       new THREE.Vector3 ( i*W, cell_noise.value((i)/N, (j-1)/N)[0]*H, (j-1)*W),

       	     new THREE.Vector3 ( i*W, cell_noise.value((i)/N, (j-1)/N)[0]*H, (j-1)*W),

       	     new THREE.Vector3 ( i*W, cell_noise.value((i)/N, j/N)[0]*H, j*W),

       	     new THREE.Vector3 ((i-1)*W, cell_noise.value((i-1)/N, j/N)[0]*H, j*W)
          );

          geometry.faces.push (
            new THREE.Face3((i+j*N)*6, (i+j*N)*6+1, (i+j*N)*6+2),
            new THREE.Face3((i+j*N)*6+3, (i+j*N)*6+4, (i+j*N)*6+5)
          );
        }
      }
      mesh = new THREE.Mesh (geometry, material);
      mesh.translateX(-N/2*W);
      mesh.translateZ(-N/2*W);
      scene.add(mesh);
    }


    var render = function () {

            var time = performance.now();
      var R = 2000;
      var f = 0.0002;
      camera.position.x = R*Math.sin(time*f);
      camera.position.y = 1000;
      camera.position.z = R*Math.cos(time*f);

      camera.lookAt (new THREE.Vector3 (0,0,0));

      mesh.material.uniforms.time.value = time;

      requestAnimationFrame (render);
      renderer.render (scene, camera);
    };

    init_gl();
    render();

    </script>
  </body>
  </html>
